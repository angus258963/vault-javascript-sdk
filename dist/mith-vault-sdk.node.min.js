"use strict";function _interopDefault(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var CryptoJS=_interopDefault(require("crypto-js")),axios=_interopDefault(require("axios"));function _classCallCheck(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,n){for(var e=0;e<n.length;e++){var a=n[e];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function _createClass(t,n,e){return n&&_defineProperties(t.prototype,n),e&&_defineProperties(t,e),t}var MithVaultSDK=function(){function a(t,n,e){_classCallCheck(this,a),this.host="https://2019-hackathon.mithvault.io",this.api="https://2019-hackathon.api.mithvault.io",this.authorize="/#/oauth/authorize",this.donate="/#/donate",this.clientId=t,this.clientSecert=n,this.miningKey=e}return _createClass(a,[{key:"getBindURI",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,n={client_id:this.clientId,state:t||_uuid()},e=Object.keys(n).map(function(t){return"".concat(t,"=").concat(n[t])}).join("&");return"".concat(this.host).concat(this.authorize,"?").concat(e)}},{key:"getDonateURI",value:function(t,n,e,a,i){var o={app_id:t,user_id:n,amount:e,state:a,desc:i},r=Object.keys(o).map(function(t){return"".concat(t,"=").concat(o[t])}).join("&");return"".concat(this.host).concat(this.donate,"?").concat(r)}},{key:"getAccessToken",value:function(t,n){var e={client_id:this.clientId,timestamp:Math.floor(Date.now()/1e3),nonce:_randomInt(),grant_code:t,state:n};return _sendAPI.call(this,"oauth/token","POST",{data:e})}},{key:"delUnbindToken",value:function(t){var n={client_id:this.clientId,timestamp:Math.floor(Date.now()/1e3),nonce:_randomInt()},e={Authorization:t};return _sendAPI.call(this,"oauth/token","DELETE",{headers:e,params:n})}},{key:"getClientInformation",value:function(){var t={client_id:this.clientId,timestamp:Math.floor(Date.now()/1e3),nonce:_randomInt()};return _sendAPI.call(this,"oauth/balance","GET",{params:t})}},{key:"getUserInformation",value:function(t){var n={client_id:this.clientId,timestamp:Math.floor(Date.now()/1e3),nonce:_randomInt()},e={Authorization:t};return _sendAPI.call(this,"oauth/user-info","GET",{headers:e,params:n})}},{key:"getUserMiningAction",value:function(t){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,e={client_id:this.clientId,timestamp:Math.floor(Date.now()/1e3),nonce:_randomInt(),mining_key:this.miningKey},a={Authorization:t};return n&&(e.next_id=n),_sendAPI.call(this,"mining","GET",{headers:a,params:e})}},{key:"postUserMiningAction",value:function(t){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,a=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,i=new Date,o=function(t){return t.toString().padStart(2,0)},r={client_id:this.clientId,timestamp:Math.floor(Date.now()/1e3),nonce:_randomInt(),mining_key:this.miningKey,uuid:n||_uuid(),reward:e,happened_at:a||"".concat(i.getUTCFullYear(),"-").concat(o(i.getUTCMonth()),"-").concat(o(i.getUTCDate()),"T").concat(o(i.getUTCHours()),":").concat(o(i.getUTCMinutes()),":").concat(o(i.getUTCSeconds()))},c={Authorization:t};return _sendAPI.call(this,"mining","POST",{headers:c,data:r})}},{key:"deleteUserMiningAction",value:function(t,n){var e={client_id:this.clientId,timestamp:Math.floor(Date.now()/1e3),nonce:_randomInt(),mining_key:this.miningKey,uuid:n||_uuid()},a={Authorization:t};return _sendAPI.call(this,"mining","DELETE",{headers:a,params:e})}}]),a}();function _uuid(){var e=Date.now();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(e+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)})}function _sendAPI(t){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"GET",e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{headers:null,data:null,params:null},a=e.params||e.data||{},i=e.headers||{};if("client_id"in a){var o=_generateSignature(a,CryptoJS.enc.Hex.parse(this.clientSecert));i["X-Vault-Signature"]=o}var r="".concat(this.api,"/").concat(t);try{return axios({method:n,url:r,params:e.params,data:e.data,headers:i}).then(function(t){return t.data}).catch(function(t){throw t})}catch(t){throw t}}function _generateSignature(t,n){var e="";if(t&&Array.isArray(t))e=t.join(",");else if(t){var a=_sortObject(t);e=Object.keys(a).map(function(t){return"".concat(t,"=").concat(a[t])}).join("&")}else t&&(e=t.toString());var i=CryptoJS.HmacSHA512(e,n);return CryptoJS.enc.Hex.stringify(i)}function _sortObject(e){return Object.keys(e).sort().reduce(function(t,n){return t[n]=e[n],t},{})}function _randomInt(){return Math.floor(1e17*Math.random())}module.exports=MithVaultSDK;
